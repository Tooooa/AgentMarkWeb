# AgentMark 项目启动指南

本文档介绍如何启动 AgentMark 项目的后端服务和前端界面。

## 1. 环境准备

请确保您的系统已安装以下环境：

- **Python**: 3.9 或更高版本
- **Node.js**: 18.0 或更高版本 (推荐使用 LTS)
- **NPM**: 通常随 Node.js 一起安装

### 由于 API 检索需要加载缓存文件，请确保执行以下操作：

项目根目录下提供了 `retriever_cache.zip`，通过解压该文件可以免去长时间的索引过程。

```bash
# 进入项目根目录
cd AgentMark

# 解压检索缓存到指定目录
unzip -o retriever_cache.zip -d experiments/toolbench/data/data/toolenv/tools
```

### 安装 Python 依赖

项目根目录（例如 `.`）下有 `requirements.txt`。请运行以下命令安装所需库：

```bash
# 进入项目根目录
cd AgentMark  # 假设您已在项目父目录，或者直接在当前项目根目录操作

# 安装所有依赖 (包含 Dashboard 后端)
pip install -r requirements.txt
```

## 2. 启动后端 (Backend)

后端服务基于 FastAPI，处理模型调用和数据检索。

1.  **打开一个新的终端窗口**。
2.  进入项目根目录：
    ```bash
    cd AgentMark  # 或者直接在当前根目录
    ```
3.  启动服务：
    ```bash
    python dashboard/server/app.py
    ```

**成功提示**：
当您看到类似 `Uvicorn running on http://0.0.0.0:8000` 的输出时，说明后端已成功启动。

> **注意**：后端服务默认监听 **8000** 端口。

## 3. 启动前端 (Frontend)

前端界面基于 React + Vite。

1.  **打开一个新的终端窗口**。
2.  进入 Dashboard 目录：
    ```bash
    cd dashboard
    ```
3.  安装前端依赖 (仅首次需要)：
    ```bash
    npm install
    ```
4.  启动开发服务器：
    ```bash
    npm run dev
    ```

**成功提示**：
终端会显示访问地址，通常为：
```
  ➜  Local:   http://localhost:5173/
```

## 4. 访问应用

打开浏览器，访问前端终端中显示的地址 (例如 `http://localhost:5173` 或 `http://127.0.0.1:5173`) 即可使用 AgentMark 界面。

---

## 5. 使用我们的插件

该流程用于验证“工具调用 + 水印采样”的插件路线：外部 Agent 不改业务代码，只改出口地址（OPENAI_BASE_URL）。

### 5.1 启动网关代理（AgentMark Proxy）

打开终端 1：

```bash
cd /mnt/c/Users/25336/Desktop/AgentMarkWeb
source ~/miniconda3/etc/profile.d/conda.sh && conda activate AgentMark

export DEEPSEEK_API_KEY=sk-你的key
export TARGET_LLM_MODEL=deepseek-chat
export AGENTMARK_DEBUG=1
export AGENTMARK_TWO_PASS=0   # 走“代理构造 tool_calls”的插件方式

uvicorn agentmark.proxy.server:app --host 0.0.0.0 --port 8001
```

### 5.2 启动前端

打开终端 2：

```bash
cd /mnt/c/Users/25336/Desktop/AgentMarkWeb/dashboard
npm install
npm run dev
```

浏览器访问 `http://localhost:5173`。  
后续在前端可以看到会话与水印可视化。

### 5.3 运行你的Agent（以Swarm为例）

打开终端 3：

```bash
cd /mnt/c/Users/25336/Desktop/AgentMarkWeb/swarm
pip install -e .

export OPENAI_BASE_URL=http://localhost:8001/v1
export OPENAI_API_KEY=anything

python -m pytest -q examples/weather_agent/evals.py -k test_calls_weather_when_asked --disable-warnings -s
```

### 5.4 验证点

在 **网关代理终端** 可以看到：

- `[agentmark:scoring_request]`：评分指令注入
- `[agentmark:tool_calls_proxy]`：网关构造的工具调用（含参数）
- `[watermark]`：水印结果与可视化数据

在 **前端** 可查看当前会话与水印分布可视化。

---

## 常见问题

- **端口被占用**：如果 8000 或 5173 端口被占用，请检查是否有其他服务正在运行，或者修改配置文件 (前端在 `vite.config.ts`, 后端在 `app.py` 底部)。
- **依赖缺失**：如果启动后端时报错 `ModuleNotFoundError`，请根据错误提示使用 `pip install <缺少包名>` 进行安装。
- **Proxy 500/502**：确认 `DEEPSEEK_API_KEY` 已设置，且网关服务在 8001 端口运行。
